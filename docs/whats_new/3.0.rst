.. doctest-skip-all

.. _whatsnew-3.0:

****************************
What's New in Photutils 3.0?
****************************

Here we highlight some of the new functionality of the 3.0 release.
In addition to these changes, Photutils 3.0 includes several
smaller improvements and bug fixes, which are described in the full
:ref:`changelog`.

.. contents::
   :local:
   :depth: 2


Dependency Version Updates
==========================

Photutils 3.0 bumps the minimum required versions of several key
dependencies to provide users with access to the latest features and
performance improvements:

- NumPy minimum version is now 2.0
- SciPy minimum version is now 1.13
- Matplotlib minimum version is now 3.9
- scikit-image minimum version is now 0.23


Refactored ePSF Building
=========================

The ePSF building tools have been significantly refactored for improved
robustness, better diagnostics, and a cleaner API.

New EPSFBuildResult class
-------------------------

:class:`~photutils.psf.EPSFBuilder` now returns an
:class:`~photutils.psf.EPSFBuildResult` dataclass instead of a plain
tuple. The result object provides structured access to detailed build
diagnostics::

    >>> from photutils.psf import EPSFBuilder
    >>> builder = EPSFBuilder(oversampling=4)
    >>> result = builder(stars)
    >>> result.epsf  # the constructed ePSF (ImagePSF)
    >>> result.fitted_stars  # stars with updated centers/fluxes
    >>> result.iterations  # number of iterations performed
    >>> result.converged  # whether the build converged
    >>> result.final_center_accuracy  # max center shift in last iteration

Backward compatibility is maintained. Existing code using tuple
unpacking will continue to work::

    >>> epsf, stars = builder(stars)

Improved star exclusion handling
--------------------------------

Stars that repeatedly fail fitting are now automatically excluded from
subsequent iterations, with informative warnings indicating the reason
for exclusion (e.g., fit region extends beyond the cutout, or the fit
did not converge). The number of excluded stars and their indices are
reported in the :class:`~photutils.psf.EPSFBuildResult`.


New SourceGroups class
======================

A new :class:`~photutils.psf.SourceGroups` class provides a convenient
and feature-rich interface for working with source grouping results. It
includes:

* Direct access to group IDs via the ``groups`` attribute
* Properties for ``n_sources``, ``n_groups``, ``sizes``, and
  ``group_centers``
* The ``get_group_sources(group_id)`` method to retrieve sources in a
  specific group
* A ``plot()`` method to visualize grouping results with color-coded
  apertures

A :class:`~photutils.psf.SourceGroups` object can be returned by the
:class:`~photutils.psf.SourceGrouper` class when called with the
``return_source_groups=True`` keyword argument::

    >>> from photutils.psf import SourceGrouper
    >>> grouper = SourceGrouper(min_separation=10)
    >>> groups = grouper(x, y, return_source_groups=True)
    >>> print(groups.n_groups)  # number of groups

It can also be instantiated directly from source positions and group
IDs::

    >>> from photutils.psf import SourceGroups
    >>> groups = SourceGroups(x, y, group_ids)


New CentroidQuadratic class
============================

A new :class:`~photutils.centroids.CentroidQuadratic`
class provides a callable object interface to the
:func:`~photutils.centroids.centroid_quadratic` function. This
class allows users to create a centroid function with specific
fit parameters that can be reused multiple times. This is
particularly useful when passing customized centroid functions to
:func:`~photutils.centroids.centroid_sources` or other functions that
accept a centroid function as an argument.

The class is initialized with the desired ``fit_boxsize`` parameter,
and then can be called with ``data`` and optional ``mask`` parameter::

    >>> from photutils.centroids import CentroidQuadratic
    >>> centroid_func = CentroidQuadratic(fit_boxsize=7)
    >>> x, y = centroid_func(data, mask=mask)

This is especially beneficial when using
:func:`~photutils.centroids.centroid_sources` with fine-tuned centroid
parameters::

    >>> from photutils.centroids import centroid_sources
    >>> centroid_func = CentroidQuadratic(fit_boxsize=11)
    >>> x, y = centroid_sources(data, x_init, y_init, box_size=25,
    ...                         centroid_func=centroid_func)


Improved Handling of Non-Finite Local Background Values in PSF Photometry
=========================================================================

:class:`~photutils.psf.PSFPhotometry` and
:class:`~photutils.psf.IterativePSFPhotometry` now gracefully handle
non-finite (NaN or inf) local background values instead of raising an
error. This situation can occur when the local background estimator
encounters fully masked regions within the background annulus.

When a non-finite local background value is encountered:

1. The actual non-finite value is preserved and reported in the output
   table's ``local_bkg`` column
2. The value is not subtracted from the data before PSF fitting
3. A new flag (bit 2048, ``NON_FINITE_LOCALBKG``) is set in the
   ``flags`` column to indicate the issue

This allows users to identify and handle problematic sources
appropriately while still obtaining PSF fitting results where possible.


Enhanced PSF Photometry Result Conversion Methods
==================================================

The :meth:`~photutils.psf.PSFPhotometry.results_to_init_params` and
:meth:`~photutils.psf.PSFPhotometry.results_to_model_params` methods
(and their :class:`~photutils.psf.IterativePSFPhotometry` equivalents)
now support two new optional keyword arguments:

* ``remove_invalid``: When ``True``, removes sources with non-finite
  fitted parameters (positions or flux) or invalid flags from the
  output table. This is useful for iterative PSF photometry workflows
  where you want to exclude failed fits from subsequent iterations.

* ``reset_ids``: When ``True``, renumbers the source IDs sequentially
  starting from 1. This is particularly useful in combination with
  ``remove_invalid=True`` to maintain consecutive IDs after removing
  sources.

These options provide more flexibility when converting PSF photometry
results for use in subsequent fitting iterations or other analyses.


New PSF decode_flags convenience method
=======================================

The :class:`~photutils.psf.PSFPhotometry` and
:class:`~photutils.psf.IterativePSFPhotometry` classes now have a
convenient ``decode_flags()`` method that decodes the bitwise flags from
the ``'flags'`` column in the results table. The method returns a list
of lists, where each inner list contains the active flag names for the
corresponding source. This makes it easy to interpret which conditions
were encountered during PSF fitting for each source.


New ImagePSF shape property
===========================

:class:`~photutils.psf.ImagePSF` now has a ``shape`` property that
returns the shape of the (oversampled) PSF data array.


Removed Deprecations
====================

The following previously deprecated features from the
``background`` package have been removed:

* The ``Background2D`` ``edge_method`` keyword argument.
* The ``Background2D`` ``background_mesh_masked``,
  ``background_rms_mesh_masked``, and ``mesh_nmasked`` properties.
* The ``BkgZoomInterpolator`` ``grid_mode`` keyword argument.

For the ``psf`` package, the previously deprecated
``FittableImageModel`` and ``EPSFModel`` classes have been removed. Use
:class:`~photutils.psf.ImagePSF` instead.


New Deprecations
================

Background Package
------------------

The ``interpolator`` keyword argument for ``Background2D`` is
now deprecated. When ``interpolator`` is eventually removed, the
``scipy.ndimage.zoom`` cubic spline interpolator will always be used to
resize the low-resolution arrays. The behavior will be identical to the
current ``BkgZoomInterpolator`` default.

Relatedly, the ``BkgIDWInterpolator`` and ``BkgZoomInterpolator``
classes are now deprecated. The ``BkgIDWInterpolator`` is not
well-suited for resizing images on a regular grid to larger sizes. It
is also significantly slower than the default interpolator based on
``scipy.ndimage.zoom``. The ``BkgZoomInterpolator`` functionality will
be preserved in the default resizing behavior of ``Background2D``.

Centroids Package
-----------------

The ``xpeak``, ``ypeak``, and ``search_boxsize`` keyword arguments
for :func:`~photutils.centroids.centroid_quadratic` function are now
deprecated. Use the :func:`~photutils.centroids.centroid_sources`
function to centroid sources at specific positions.

PSF Package
-----------

The ``grid_from_epsfs`` helper function is now deprecated. This function
creates a ``GriddedPSFModel`` from a list of ePSFs. Instead, use the
``GriddedPSFModel`` class directly.

The :class:`~photutils.psf.EPSFFitter` class is now deprecated.
To customize the ePSF fitting process, use the ``fitter``,
``fit_shape``, and ``fitter_maxiters`` parameters of
:class:`~photutils.psf.EPSFBuilder` directly instead of creating an
``EPSFFitter`` instance.


Breaking Changes
================

The ``EPSFBuilder.build_epsf()`` method has been removed. Use the
``EPSFBuilder`` callable interface instead (i.e., ``builder(stars)``).

The ``norm_radius`` keyword has been removed from
:class:`~photutils.psf.EPSFBuilder`. This keyword is no
longer relevant because the ePSF is now built directly as an
:class:`~photutils.psf.ImagePSF`, which does not use a normalization
radius.

All functions in the `~photutils.centroids` package now require
keyword-only arguments.
